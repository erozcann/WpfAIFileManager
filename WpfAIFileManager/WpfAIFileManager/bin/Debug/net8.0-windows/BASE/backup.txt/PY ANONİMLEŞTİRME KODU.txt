print("âœ… Python scripti baÅŸladÄ±...")

import cv2
import fitz  # PyMuPDF
import numpy as np
import os
import spacy
from sklearn.feature_extraction.text import TfidfVectorizer

# OpenCV YÃ¼z TanÄ±ma Modelini YÃ¼kle
face_cascade = cv2.CascadeClassifier("haarcascade_frontalface_default.xml")

# NLP Modelini YÃ¼kle (BERT tabanlÄ± model)
nlp = spacy.load("en_core_web_trf")

# ğŸ” GeniÅŸletilmiÅŸ Ä°lgi AlanÄ± Kelime Havuzu
CATEGORIES = {
    "Artificial Intelligence": [
        "machine learning", "deep learning", "neural networks", "natural language processing",
        "computer vision", "reinforcement learning", "generative ai", "large language models",
        "transformers", "autoencoders", "supervised learning", "unsupervised learning",
        "clustering", "ai ethics", "explainable ai", "decision trees", "random forest",
        "support vector machines", "bayesian networks", "gradient boosting"
    ],
    "Human-Computer Interaction": [
        "brain-computer interface", "user experience", "usability testing", "haptic feedback",
        "augmented reality", "virtual reality", "gesture recognition", "eye tracking",
        "human-centered design", "adaptive interfaces", "voice interfaces", "multimodal interaction",
        "emotion recognition", "wearable technology", "brain wave analysis"
    ],
    "Big Data & Analytics": [
        "data mining", "data visualization", "big data", "hadoop", "spark", "stream processing",
        "data warehousing", "time series analysis", "predictive analytics", "cloud data storage",
        "etl pipelines", "real-time analytics", "graph databases", "data lakes", "kafka", "nosql"
    ],
    "Cybersecurity": [
        "encryption", "network security", "firewalls", "digital forensics", "cyber attacks",
        "malware analysis", "penetration testing", "phishing detection", "secure software development",
        "authentication", "zero trust security", "ransomware", "ddos attacks", "threat intelligence",
        "dark web monitoring", "siem", "blockchain security"
    ],
    "Distributed Systems": [
        "cloud computing", "serverless computing", "edge computing", "p2p networks",
        "5G networks", "blockchain", "distributed ledgers", "fault tolerance", "microservices",
        "message queues", "container orchestration", "kubernetes", "docker", "event-driven architecture"
    ]
}

ANONYMIZE_ENTITIES = ["PERSON", "EMAIL", "ORG"]  # AnonimleÅŸtirilecek bilgi tÃ¼rleri


def detect_and_blur_faces(image):
    """Resimdeki yÃ¼zleri bulanÄ±klaÅŸtÄ±rÄ±r."""
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)  # GÃ¶rÃ¼ntÃ¼yÃ¼ gri tonlamaya Ã§evir
    faces = face_cascade.detectMultiScale(gray, scaleFactor=1.1, minNeighbors=5, minSize=(30, 30))

    for (x, y, w, h) in faces:
        face_region = image[y:y+h, x:x+w]
        blurred_face = cv2.GaussianBlur(face_region, (99, 99), 30)  # YÃ¼zÃ¼ bulanÄ±klaÅŸtÄ±r
        image[y:y+h, x:x+w] = blurred_face  # BulanÄ±k yÃ¼zÃ¼ orijinal gÃ¶rÃ¼ntÃ¼ye geri ekle

    return image


def extract_images_from_pdf(pdf_path):
    """PDF iÃ§indeki tÃ¼m resimleri alÄ±r ve yÃ¼zleri bulanÄ±klaÅŸtÄ±rÄ±r."""
    pdf_reader = fitz.open(pdf_path)
    pdf_writer = fitz.open()

    print(f"ğŸ“Œ PDF {len(pdf_reader)} sayfa iÃ§eriyor.")  # Yeni eklenen satÄ±r

    for page_num in range(len(pdf_reader)):
        page = pdf_reader[page_num]
        img_list = page.get_images(full=True)

        print(f"ğŸ“Œ Sayfa {page_num + 1}: {len(img_list)} resim bulundu.")  # Yeni eklenen satÄ±r

        for img_index, img in enumerate(img_list):
            xref = img[0]
            base_image = pdf_reader.extract_image(xref)
            image_bytes = base_image["image"]
            img = cv2.imdecode(np.frombuffer(image_bytes, np.uint8), cv2.IMREAD_COLOR)

            # YÃ¼zleri bulanÄ±klaÅŸtÄ±r
            blurred_image = detect_and_blur_faces(img)

            # BulanÄ±klaÅŸtÄ±rÄ±lmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼yÃ¼ PDF'e geri ekle
            img_stream = fitz.open("png", blurred_image)
            page.insert_image(page.rect, stream=img_stream.read(), xref=xref)

    if len(pdf_reader) == 0:
        print("âŒ Hata: PDF iÃ§inde hiÃ§ sayfa bulunamadÄ±!")
        return pdf_path  # Orijinal dosyayÄ± dÃ¶ndÃ¼r

    output_pdf_path = pdf_path.replace(".pdf", "_anonim.pdf")
    pdf_writer.save(output_pdf_path)
    print(f"âœ… AnonimleÅŸtirilmiÅŸ PDF kaydedildi: {output_pdf_path}")  # Yeni eklenen satÄ±r
    return output_pdf_path


def anonymize_text(text):
    """PDF metninde yazar bilgilerini `*****` ile deÄŸiÅŸtirir."""
    doc = nlp(text)
    new_text = text
    for ent in doc.ents:
        if ent.label_ in ANONYMIZE_ENTITIES:
            new_text = new_text.replace(ent.text, "*****")
    return new_text


def extract_text_from_pdf(pdf_path):
    """PDF'den metin Ã§Ä±karÄ±r ve anonimleÅŸtirir."""
    pdf_reader = fitz.open(pdf_path)
    new_pdf = fitz.open()

    for page_num in range(len(pdf_reader)):
        page = pdf_reader[page_num]
        text = page.get_text()

        # Belirli bÃ¶lÃ¼mlerde anonimleÅŸtirme yapma (GiriÅŸ, Referanslar vb.)
        section_titles = ["Introduction", "Related Work", "References", "Acknowledgments"]
        if any(title in text for title in section_titles):
            new_text = text  # Bu bÃ¶lÃ¼mlerde deÄŸiÅŸiklik yapma
        else:
            new_text = anonymize_text(text)  # AnonimleÅŸtir

        # Yeni sayfa oluÅŸtur ve anonimleÅŸtirilmiÅŸ metni ekle
        new_page = new_pdf.new_page(width=page.rect.width, height=page.rect.height)
        new_page.insert_text((50, 50), new_text)

    output_pdf_path = pdf_path.replace(".pdf", "_anonim_text.pdf")
    new_pdf.save(output_pdf_path)
    return output_pdf_path


def extract_keywords(text):
    """TF-IDF ile en Ã¶nemli anahtar kelimeleri Ã§Ä±karÄ±r."""
    vectorizer = TfidfVectorizer(stop_words="english", max_features=20)  # Daha fazla kelime al
    tfidf_matrix = vectorizer.fit_transform([text])
    feature_names = vectorizer.get_feature_names_out()
    return feature_names


def assign_category(text):
    """Makalenin anahtar kelimelerine gÃ¶re en uygun kategoriyi belirler."""
    keywords = extract_keywords(text)
    category_scores = {category: sum(1 for keyword in keywords if keyword in words) for category, words in
                       CATEGORIES.items()}

    # En fazla eÅŸleÅŸen kategoriyi belirle
    max_score = max(category_scores.values())
    assigned_categories = [cat for cat, score in category_scores.items() if score == max_score]

    return assigned_categories


def anonymize_pdf(pdf_path):
    print(f"ğŸ“Œ BaÅŸlatÄ±lÄ±yor: {pdf_path}")
    anonymized_text_pdf = extract_text_from_pdf(pdf_path)  # Metin anonimleÅŸtirme
    print("ğŸ“Œ Metin anonimleÅŸtirildi.")
    anonymized_images_pdf = extract_images_from_pdf(anonymized_text_pdf)  # GÃ¶rselleri anonimleÅŸtirme
    print("ğŸ“Œ GÃ¶rseller anonimleÅŸtirildi.")

    # Anahtar kelimeleri Ã§Ä±kar ve ilgi alanÄ± ata
    with fitz.open(anonymized_text_pdf) as pdf_reader:
        full_text = "\n".join([page.get_text() for page in pdf_reader])
        assigned_categories = assign_category(full_text)
    print(f"ğŸ“Œ Kategoriler belirlendi: {', '.join(assigned_categories)}")

    return anonymized_images_pdf
if __name__ == "__main__":
    import sys

    if len(sys.argv) < 2:
        print("âŒ Hata: PDF dosya yolu belirtilmedi!")
        sys.exit(1)

    pdf_path = sys.argv[1]
    print(f"âœ… PDF Dosya Yolu: {pdf_path}")

    anonymized_pdf = anonymize_pdf(pdf_path)
    print(f"ğŸš€ AnonimleÅŸtirilmiÅŸ PDF oluÅŸturuldu: {anonymized_pdf}")
